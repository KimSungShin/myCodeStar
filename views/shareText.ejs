<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>iFriendsPet</title>

    <meta property="og:type" content="website">
    <meta property="og:title" content="iFriendsPet">
    <meta property="og:image" content="<%= photo %>">
    <meta property="fb:app_id" content="203562140050845">
    <meta property="og:description" content="iFriendsPet"/>
    <meta property="og:url" content="<%= photo %>"/>

    <link rel="stylesheet" href="/public/stylesheets/shareText.css">
    <script  src="https://code.jquery.com/jquery-latest.min.js"></script>
    <script src="../public/javascripts/executeAppOrGoStore.js"></script>
</head>
<body>

<script>
    var dw;
    var tValue = "", tTemp = "", tblock ="";
    var tAry = [], chunkAry = [];
    var i=0, j=0, k=0, colNum=0;
    var requiredBlankNum = 0, tAryLen = 0;
    var space = 30;//40;
    var encodedStr, parser, dom, decodedString;//function decoding
    var delta, timer = null;//resize

    $(document).ready(function() {


        tValue = `<%= text %>`;

        tTemp = decoding(tValue);//특수문자 일반문자로 치환

        dw = $(window).width();
        colNum = Math.floor(($(".main").width() - $(".main").width()*0.1)/space);

        drawPaper( tTemp );

        delta = 300;
        timer = null;
        $( window ).on( 'resize', function( ) {
            dw = $(window).width();
            colNum = Math.floor(($(".main").width() - $(".main").width()*0.1)/space);

            clearTimeout( timer );
            timer = setTimeout( function a() { drawPaper(tTemp) }, delta );//resize시한번만호출
        });
    });



    function drawPaper( str )
    {
        var korean = /[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/;
        var isKorean = false;
        var emoji = "";
        var stringByteLength = 0;
        var oneChar = "";
        var tempStr = "";
        var rowAry = [];
        var rowNum = 0;
        var textareaAry = [], tempAry = [], tempAry2 = [], resultAry = [];;
        var chunkstr;
        var newArray;

        testAry = str.split("\n");
        for(i=0; i<testAry.length; ++i) {
            rowAry = [];
            for(j=0;j<testAry[i].length;++j) {
                chunkstr = testAry[i];
                oneChar = chunkstr.substr(j, 1);
                isKorean = korean.test(oneChar);
                stringByteLength = (function(s,b,i,c){
                    for(b=i=0;c=s.charCodeAt(i++);b+=c>>11?3:c>>7?2:1);
                    return b
                })(oneChar);

                if(stringByteLength == 3 && !isKorean) {
                    emoji = chunkstr.substr(j, 2);
                    rowAry.push(emoji);
                    ++j;
                } else {
                    rowAry.push(oneChar);
                }
            }
            textareaAry.push(rowAry);
        }

        for(i=0; i<textareaAry.length; ++i) {
            tempAry = textareaAry[i];
            if(tempAry.length > colNum) {//글 수가 가로칸 수를 넘으면
                tempAry2 = tempAry;
                newArray = new Array(Math.ceil(tempAry2.length / colNum)).fill("").map(function() { return this.splice(0, colNum) }, tempAry2.slice());
                for (j=0; j<newArray.length; ++j) {
                    tempAry.splice(i, 0, newArray[j]);
                    resultAry.push(newArray[j]);
                }
            } else {
                resultAry.push(tempAry);
            }
        }

        for(i=0;i<resultAry.length;++i) {
            requiredBlankNum = colNum - resultAry[i].length;
            for(j=0;j<requiredBlankNum;++j) {
                resultAry[i].push(" ");
            }
        }

        tblock = "";
        for(i=0; i<resultAry.length; ++i) {
            for(j=0;j<resultAry[i].length;++j) {
                (resultAry[i][j] == " ") ? tblock += "<span>&nbsp;</span>" : tblock += "<span>" + resultAry[i][j] + "</span>";
            }
        }

        $(".snapTextArea").empty().css({width: colNum * (space-1)}).append(tblock);
        $(".main .cover").css({left: colNum * (space-1) - $(".main .cover img").width() + 40});
        console.log($(".snapTextArea").position().left, $(".snapTextArea").width(), $(".main .cover img").width() );

//    for(i=0;i<resultAry.length;++i) console.log(resultAry[i]);
    }

    //특수문자->일반문자 치환하는 함수 ex)&amp -> &
    function decoding( value ) {
        encodedStr = value;
        parser = new DOMParser;
        dom = parser.parseFromString('<!doctype html><body>' + encodedStr, 'text/html');
        decodedString = dom.body.textContent;
//    console.log(decodedString);
        return decodedString;
    }
</script>

<div class="container">
    <div class="main">
        <div class="cover">
            <img src="/public/images/shareTxtTitle.png" />
        </div>
        <div class="snapTextArea">
        </div>
        <div class="deco">
            <img src="/public/images/leafs.png" />
        </div>



        <% if( !preview ){ %>
        <div class="footerCon">
            <div class="footer">
                <img class="logo" src="/public/images/logo.png" />
                <div class="btnCon">
                    <a href="http://www.ifriendspet.com" target="_blank" class="btn0 btn">홈페이지 바로가기</a>
                    <a href="javascript:void(0)" onclick="executeAppOrGoStore();" class="btn1 btn" >앱 구경하기</a>
                </div>
            </div>
        </div>
        <% } %>


    </div>
</div>
</body>
</html>